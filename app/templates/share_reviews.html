{% extends "base.html" %}
{% block title %}Manage Sharing{% endblock %}
{% block content %}
<div class="container text-light py-5">
  <h2 class="text-warning text-center mb-4">ðŸ”— Share Your Reviews and Analytics</h2>

  <!-- Autocomplete search bar -->
  <input type="text" id="usernameInput" class="form-control" placeholder="Search username...">
  <ul id="autocompleteResults" class="list-group mt-2 mb-4"></ul>

  <!-- List of selected users with toggles -->
  <div id="selectedUsersList" class="mb-4"></div>

  <div class="text-center">
    <button id="saveButton" class="btn btn-warning">Save Sharing Settings</button>
  </div>
</div>

<script>
  const selectedShares = new Map(); // username -> { review: true/false, analytics: true/false }

  const input = document.getElementById("usernameInput");
  const results = document.getElementById("autocompleteResults");
  const selectedList = document.getElementById("selectedUsersList");

  input.addEventListener("input", async function () {
    const query = this.value.trim();
    results.innerHTML = "";

    if (query.length < 2) return;

    try {
      const res = await fetch(`/users/search_user?q=${encodeURIComponent(query)}`);
      const users = await res.json();

      if (users.length === 0) {
        results.innerHTML = `<li class="list-group-item text-muted">No users found</li>`;
      } else {
        users.forEach(username => {
          const item = document.createElement("li");
          item.className = "list-group-item list-group-item-action";
          item.textContent = username;

          item.addEventListener("click", function () {
            addUserWithToggles(username);
            results.innerHTML = "";
            input.value = "";
          });

          results.appendChild(item);
        });
      }
    } catch (err) {
      console.error("Search error:", err);
    }
  });

  function addUserWithToggles(username) {
    if (selectedShares.has(username)) return;

    selectedShares.set(username, { review: false, analytics: false });

    const container = document.createElement("div");
    container.className = "list-group-item bg-dark text-light d-flex justify-content-between align-items-center mb-2";
    container.innerHTML = `
      <strong>${username}</strong>
      <div class="d-flex gap-4">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" data-user="${username}" data-type="review">
          <label class="form-check-label ms-1">Share Review</label>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" data-user="${username}" data-type="analytics">
          <label class="form-check-label ms-1">Share Analytics</label>
        </div>
      </div>
    `;

    container.querySelectorAll("input[type='checkbox']").forEach(toggle => {
      toggle.addEventListener("change", function () {
        const type = this.dataset.type;
        const user = this.dataset.user;
        const entry = selectedShares.get(user);
        entry[type] = this.checked;
        selectedShares.set(user, entry);
      });
    });

    selectedList.appendChild(container);
  }

  document.getElementById("saveButton").addEventListener("click", async function () {
    const payload = [];

    for (const [username, prefs] of selectedShares.entries()) {
      if (prefs.review || prefs.analytics) {
        payload.push({ username, ...prefs });
      }
    }

    const res = await fetch("/users/save_shares", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ shares: payload })
    });

    if (res.ok) {
      alert("Sharing settings saved!");
      location.reload();
    } else {
      alert("Failed to save settings.");
    }
  });
</script>
{% endblock %}
